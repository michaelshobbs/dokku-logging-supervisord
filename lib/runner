#!/bin/bash

set -e
export HOME=/app
hash -r
cd $HOME

if [[ -d /app/.profile.d ]]; then
  for file in /app/.profile.d/*.sh; do
    source $file
  done
fi
# need to unset PYTHON vars to use apt installed supervisord
unset PYTHONHOME
unset PYTHONPATH

# Generate supervisord.conf:
bash /build/procfile-to-supervisord /app/Procfile /app/SCALE > supervisord.conf

# Create /var/log/app directory
mkdir -p /var/log/app

# Get buildstep user if it exists and chown log dir
user_name=$(egrep "^u[1-9]+" /etc/passwd 2> /dev/null | awk -F':' '{ print $1 }')
if [ -n "$user_name" ];then
    chown -R ${user_name}:${user_name} /var/log/app
    chmod -R g+rw /var/log/app
    if [ -d "/mnt/whoosh_index" ];then
        chown -R ${user_name}:${user_name} /mnt/whoosh_index
        chmod -R g+rw /mnt/whoosh_index
    fi
fi

# Display the generated supervisord.conf:
echo "Generated supervisord.conf:"
cat -n supervisord.conf

# Start up the app:
supervisord -c supervisord.conf
